import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";
import { sha256 } from "@/lib/utils";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

type QuizOut = {
  kind: "quiz";
  stem: string;
  options: { label: "A" | "B" | "C" | "D"; text: string; isCorrect: boolean; explanation: string }[];
  whyCorrect: string;
  signals: string[];
  hash: string;
  source: "fixed20";
};

function normalizeText(s: string) {
  return String(s || "").replace(/\s+/g, " ").trim();
}

/** hash stable ไม่ขึ้นกับลำดับตัวเลือก */
function hashQuiz(stem: string, optionTexts: string[]) {
  const stemN = normalizeText(stem).toLowerCase();
  const optsN = optionTexts.map((t) => normalizeText(t).toLowerCase()).sort();
  return sha256(stemN + "\n" + optsN.join("\n"));
}

function shuffle<T>(arr: T[]) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/** ✅ bank 20 ข้อ: คละธีม + ไม่ทำให้ตอบข้อ 1 ถูกตลอด */
const BANK: Array<{
  stem: string;
  correct: string;
  wrong: [string, string, string];
  why: string;
  signals: string[];
}> = [
  {
    stem: "คุณได้รับ SMS แจ้งว่า “พัสดุติดศุลกากร ให้ชำระ 9 บาทภายใน 30 นาที” พร้อมลิงก์ย่อ คุณควรทำอย่างไรดีที่สุด?",
    correct: "เปิดแอป/เว็บขนส่งทางการเอง ตรวจเลขพัสดุ และอย่ากดลิงก์จาก SMS",
    wrong: ["กดลิงก์แล้วจ่ายทันทีเพราะจำนวนเงินน้อย", "ตอบกลับข้อความเพื่อขอข้อมูลเพิ่ม", "ส่งต่อให้เพื่อนกดเช็คให้"],
    why: "เข้าแอป/เว็บทางการเองลดโอกาสโดนเว็บปลอม/ขโมยข้อมูลบัตร",
    signals: ["ลิงก์ย่อ/โดเมนไม่ทางการ", "เร่งด่วนกดดันเวลา", "เรียกเก็บเงินน้อยเพื่อหลอกให้จ่ายง่าย"],
  },
  {
    stem: "มีอีเมลจาก “IT Support” ขอให้คุณล็อกอินเพื่ออัปเดตรหัสผ่าน โดยให้กดปุ่ม Login ในอีเมล คุณควรตรวจอะไรเป็นอันดับแรก?",
    correct: "ตรวจโดเมนผู้ส่ง/ลิงก์จริง (hover) ว่าเป็นโดเมนองค์กรจริงหรือไม่",
    wrong: ["ดูแค่ว่ามีโลโก้บริษัทหรือไม่", "ดูว่าภาษาไทยสะกดถูกไหม", "รีบทำตามเพราะกลัวโดนล็อกบัญชี"],
    why: "โดเมน/URL เป็นตัวชี้วัดสำคัญของเว็บปลอม",
    signals: ["ให้ล็อกอินผ่านลิงก์ในอีเมล", "ขู่ให้รีบทำ", "ปลอมเป็นฝ่าย IT"],
  },
  {
    stem: "คุณเห็นโพสต์ “แจกคูปอง 500 บาท” ในโซเชียลและมีลิงก์ให้กรอก OTP เพื่อรับสิทธิ์ คุณควรทำอย่างไร?",
    correct: "ไม่กรอก OTP และออกจากลิงก์ทันที พร้อมรายงานโพสต์/เพจ",
    wrong: ["กรอก OTP แล้วค่อยเปลี่ยนรหัสผ่านทีหลัง", "ส่ง OTP ให้เพื่อนช่วยวิเคราะห์", "กรอกเฉพาะเลขบัตร ปชช. น่าจะพอ"],
    why: "OTP คือกุญแจเข้าบัญชี การขอ OTP ผ่านลิงก์สุ่มคือสัญญาณหลอกลวง",
    signals: ["ขอ OTP", "ล่อด้วยของฟรี", "ลิงก์ไปเว็บนอกแพลตฟอร์ม"],
  },
  {
    stem: "คุณได้รับข้อความจาก “ธนาคาร” ใน LINE แจ้งให้ยืนยันตัวตนในลิงก์เพื่อปลดล็อกบัญชี คุณควรทำอย่างไร?",
    correct: "โทร/ติดต่อธนาคารผ่านเบอร์ทางการหรือเข้าแอปธนาคารเอง ไม่กดลิงก์",
    wrong: ["กดลิงก์เพราะมาจากบัญชีที่ดูมีเครื่องหมาย", "ส่งเลขบัตร+วันหมดอายุให้เพื่อยืนยัน", "ตอบว่า ‘ขอรายละเอียด’ แล้วรอ"],
    why: "ธนาคารไม่ควรขอข้อมูลอ่อนไหว/ให้กดลิงก์สุ่มผ่านแชท",
    signals: ["ปลอมเป็นธนาคาร", "ลิงก์ให้ยืนยัน", "ขู่ปลดล็อก/ปิดบัญชี"],
  },
  {
    stem: "มีอีเมลแจ้ง “คุณชนะรางวัล iPhone” และมีไฟล์แนบ .zip ให้เปิดเพื่อรับสิทธิ์ คุณควรทำอย่างไร?",
    correct: "ไม่เปิดไฟล์แนบ และลบ/รายงานอีเมล",
    wrong: ["เปิดไฟล์ในมือถือจะปลอดภัยกว่า", "ส่งไฟล์ให้เพื่อนลองเปิด", "เปิดแล้วค่อยสแกนไวรัสทีหลัง"],
    why: "ไฟล์แนบจากแหล่งไม่รู้จักเสี่ยงมัลแวร์สูง",
    signals: ["ไฟล์แนบ .zip", "ล่อด้วยรางวัล", "ให้เปิดไฟล์ทันที"],
  },
  // --- เพิ่มให้ครบ 20 ข้อ (คละธีม) ---
  {
    stem: "คุณได้รับโทรศัพท์อ้างเป็นเจ้าหน้าที่ บอกว่าคุณมีคดีและให้โอนเงินเข้าบัญชี “ตรวจสอบ” คุณควรทำอย่างไร?",
    correct: "วางสาย และติดต่อหน่วยงานผ่านช่องทางทางการเอง ไม่โอนเงิน",
    wrong: ["โอนเงินก่อนเพื่อไม่ให้เรื่องบานปลาย", "ให้ข้อมูลส่วนตัวเพื่อยืนยัน", "คุยนานๆเพื่อขอรายละเอียดแล้วค่อยตัดสินใจ"],
    why: "การโอนเงินเพื่อ ‘ตรวจสอบ’ เป็นมุกหลอกยอดฮิต",
    signals: ["ขู่คดี/กลัว", "ให้โอนเงิน", "เร่งให้ทำตามทันที"],
  },
  {
    stem: "ข้อความแจ้งว่า ‘บัญชี Streaming ของคุณหมดอายุ’ พร้อมลิงก์ให้ต่ออายุ คุณควรทำอะไร?",
    correct: "เข้าแอป/เว็บทางการเองเพื่อตรวจสถานะสมาชิก",
    wrong: ["กดลิงก์ต่ออายุทันที", "กรอกข้อมูลบัตรแล้วค่อยตรวจ", "ตอบกลับเพื่อขอส่วนลด"],
    why: "ต่ออายุควรทำในช่องทางทางการเท่านั้น",
    signals: ["ลิงก์ให้จ่ายเงิน", "โดเมนเลียนแบบได้ง่าย", "เร่งให้กด"],
  },
  {
    stem: "คุณขายของใน marketplace แล้วมีคนทักว่าจ่ายแล้ว ให้กดลิงก์ ‘รับเงิน’ คุณควรทำอย่างไร?",
    correct: "เช็คยอดในแอป marketplace/บัญชีธนาคารเอง ไม่กดลิงก์รับเงิน",
    wrong: ["กดลิงก์รับเงินเพื่อไม่ให้ลูกค้ารอ", "ให้เลขบัตรเพื่อรับเงิน", "ให้ OTP เพื่อยืนยันรับเงิน"],
    why: "มิจฉาชีพชอบปลอมเป็นการรับเงินเพื่อดูดข้อมูล/OTP",
    signals: ["ลิงก์รับเงิน", "ขอ OTP/ข้อมูลการเงิน", "รีบเร่ง"],
  },
  {
    stem: "อีเมลบอกว่า ‘คุณถูกแท็กในเอกสาร’ และให้ล็อกอิน Google ผ่านลิงก์ คุณควรทำอย่างไร?",
    correct: "เปิด Google Drive ผ่านเว็บ/แอปเอง แล้วดูว่าเอกสารถูกแชร์จริงไหม",
    wrong: ["กดลิงก์แล้วล็อกอินทันที", "ตอบอีเมลเพื่อขอลิงก์ใหม่", "ดาวน์โหลดไฟล์แนบก่อนค่อยดู"],
    why: "เว็บปลอม Google เป็นฟิชชิงยอดนิยม",
    signals: ["ให้ล็อกอินผ่านลิงก์", "ปลอมเป็นเอกสารแชร์", "URL แปลก"],
  },
  // เติมให้ครบ 20:
  {
    stem: "คุณได้ SMS ว่า ‘แต้มคะแนนคุณกำลังจะหมดอายุ’ ให้กดลิงก์แลกรางวัล คุณควรทำอะไร?",
    correct: "เข้าแอป/เว็บแบรนด์ทางการเองเพื่อตรวจแต้ม",
    wrong: ["กดลิงก์แลกทันที", "ส่งลิงก์ให้เพื่อนลองก่อน", "ให้ข้อมูลบัตรเพื่อรับของรางวัล"],
    why: "แต้มหมดอายุเป็นข้อความหลอกให้รีบกด",
    signals: ["เร่งด่วน", "ลิงก์แลกของ", "ขอข้อมูลส่วนตัว/การเงิน"],
  },
  {
    stem: "มีอีเมล ‘ใบแจ้งหนี้ค้างชำระ’ พร้อมไฟล์ .docm คุณควรทำอย่างไร?",
    correct: "อย่าเปิดไฟล์ .docm และตรวจสอบกับฝ่ายบัญชีผ่านช่องทางยืนยันได้",
    wrong: ["เปิดไฟล์แล้วกด Enable Macro", "ส่งต่อให้หัวหน้าเปิด", "ดาวน์โหลดแล้วเปิดในมือถือ"],
    why: "ไฟล์ macro เสี่ยงมัลแวร์/รันโค้ดอันตราย",
    signals: ["ไฟล์ .docm", "เรียกเก็บเงิน", "ขอให้ enable macro"],
  },
  {
    stem: "ข้อความว่า ‘บัญชีคุณผิดปกติ’ ให้ยืนยันด้วยการส่งรหัสผ่านกลับไป คุณควรทำอะไร?",
    correct: "ไม่ส่งรหัสผ่าน และเปลี่ยนรหัสผ่านผ่านช่องทางทางการเอง",
    wrong: ["ส่งรหัสผ่านเพื่อยืนยันว่าเป็นเจ้าของ", "ส่ง OTP แทนรหัสผ่าน", "บอกเลขบัตรประชาชนแทน"],
    why: "ไม่มีบริการจริงที่ขอรหัสผ่านผ่านข้อความ",
    signals: ["ขอรหัสผ่าน", "อ้างความปลอดภัย", "หลอกให้ยืนยันตัวตนผิดวิธี"],
  },
  {
    stem: "คุณได้รับ DM ว่า ‘มีรูปคุณหลุด’ พร้อมลิงก์ให้ดู คุณควรทำอย่างไร?",
    correct: "อย่ากดลิงก์ และบล็อก/รายงานผู้ส่ง",
    wrong: ["กดลิงก์ดูเพื่อความแน่ใจ", "บอกข้อมูลเพื่อให้ลบรูป", "โอนเงินเพื่อให้ลบรูป"],
    why: "เป็นเทคนิคหลอกด้วยความตกใจ/อายให้รีบกด",
    signals: ["ยั่วให้กลัว/อาย", "ลิงก์ไม่รู้ที่มา", "เร่งให้ทำทันที"],
  },
  {
    stem: "อีเมลแจ้ง ‘มีการล็อกอินจากต่างประเทศ’ ให้กดยืนยันว่าเป็นคุณ คุณควรทำอย่างไร?",
    correct: "เข้าเว็บ/แอปบริการเอง แล้วตรวจอุปกรณ์/Session จากหน้า security",
    wrong: ["กดลิงก์ในอีเมลทันที", "ตอบกลับอีเมลว่าไม่ใช่", "ส่ง OTP เพื่อยืนยันว่าไม่ใช่"],
    why: "แจ้งเตือนปลอมพาไปเว็บฟิชชิงได้",
    signals: ["ลิงก์ยืนยัน", "อ้างล็อกอินผิดปกติ", "หลอกให้รีบทำ"],
  },
  {
    stem: "มีข้อความว่า ‘คุณได้คืนภาษี’ ให้กรอกข้อมูลบัญชีผ่านลิงก์ คุณควรทำอย่างไร?",
    correct: "เข้าเว็บหน่วยงาน/แอปทางการเอง ไม่กรอกผ่านลิงก์ข้อความ",
    wrong: ["กรอกเลขบัญชีเพราะไม่ใช่ข้อมูลลับ", "ส่งสำเนาบัตร ปชช. เพื่อรับเงิน", "คุยต่อเพื่อขอรายละเอียด"],
    why: "คืนภาษีปลอมชวนกรอกข้อมูลเพื่อขโมยตัวตน",
    signals: ["อ้างหน่วยงานรัฐ", "ลิงก์กรอกข้อมูล", "ขอข้อมูลส่วนตัว"],
  },
  {
    stem: "ข้อความแจ้งว่า ‘แพ็กเกจมือถือหมด’ ให้ต่อผ่านลิงก์ คุณควรทำอะไร?",
    correct: "เปิดแอป/เว็บผู้ให้บริการเองเพื่อตรวจแพ็กเกจและต่ออายุ",
    wrong: ["กดลิงก์ต่อทันที", "ให้ OTP เพื่อยืนยันต่อแพ็กเกจ", "โอนเงินเข้าบัญชีบุคคลที่ส่งมา"],
    why: "ต่อแพ็กเกจควรทำในช่องทางผู้ให้บริการเท่านั้น",
    signals: ["ลิงก์ชำระเงิน", "ขอ OTP/ข้อมูล", "อ้างผู้ให้บริการ"],
  },
  {
    stem: "คุณได้อีเมล ‘แจ้งอัปเดตข้อมูลผู้รับเงินเดือน’ ให้กรอกข้อมูลบัญชีในฟอร์ม คุณควรทำอย่างไร?",
    correct: "ยืนยันกับ HR ผ่านช่องทางภายในที่รู้จัก และอย่ากรอกผ่านฟอร์มแปลก",
    wrong: ["กรอกเพราะมาจากอีเมล HR", "ส่งเลขบัตร+OTP เพื่อยืนยัน", "ตอบกลับว่าโอเคแล้วกรอกตามลิงก์"],
    why: "ฟอร์มปลอมใช้ขโมยข้อมูลการเงิน/ตัวตน",
    signals: ["อ้าง HR", "ฟอร์มกรอกข้อมูล", "ขอข้อมูลการเงิน"],
  },
  {
    stem: "มีอีเมล ‘ระบบจะปิดบัญชีใน 1 ชั่วโมง’ หากไม่ยืนยัน คุณควรทำอย่างไร?",
    correct: "ใจเย็น ตรวจผ่านช่องทางทางการเอง และอย่าคลิกลิงก์เร่งด่วน",
    wrong: ["กดลิงก์ยืนยันทันที", "ส่งรหัสผ่านเพื่อยืนยัน", "โอนเงินเพื่อปลดล็อก"],
    why: "การกดดันด้วยเวลาเป็นสัญญาณฟิชชิง",
    signals: ["เร่งด่วน", "ขู่ปิดบัญชี", "ลิงก์ให้ยืนยัน"],
  },
  {
    stem: "คุณได้รับข้อความว่า ‘มีคนใช้บัตรคุณ’ ให้โทรกลับเบอร์ที่แนบมา คุณควรทำอย่างไร?",
    correct: "ไม่โทรกลับเบอร์ในข้อความ ให้โทรเบอร์หลังบัตร/ช่องทางทางการเอง",
    wrong: ["โทรกลับทันทีเพื่ออายัด", "ส่งเลขบัตรเพื่อยืนยัน", "ให้ OTP เพื่อหยุดรายการ"],
    why: "เบอร์ปลอมทำให้คุยกับมิจฉาชีพโดยตรง",
    signals: ["ให้โทรกลับเบอร์แปลก", "อ้างรายการผิดปกติ", "เร่งด่วน"],
  },
  {
    stem: "อีเมลแจ้ง ‘คุณได้รับของขวัญ’ ให้กรอกที่อยู่+จ่ายค่าส่งในลิงก์ คุณควรทำอย่างไร?",
    correct: "ไม่กรอก/ไม่จ่าย และตรวจที่มาของผู้ส่งก่อนเสมอ",
    wrong: ["จ่ายค่าส่งเพราะจำนวนน้อย", "ให้ที่อยู่+เบอร์โทรก่อน", "กดลิงก์เพื่อดูรายละเอียด"],
    why: "หลอกจ่ายค่าส่ง/ขโมยข้อมูลส่วนตัว",
    signals: ["ล่อของขวัญ", "ขอจ่ายเงิน", "ลิงก์ไม่ชัดเจน"],
  },
  {
    stem: "คุณถูกขอให้ติดตั้งแอป ‘ช่วยเหลือธนาคาร’ เพื่อแก้ปัญหา คุณควรทำอย่างไร?",
    correct: "ไม่ติดตั้ง และติดต่อธนาคารผ่านช่องทางทางการเท่านั้น",
    wrong: ["ติดตั้งแล้วให้สิทธิ์ Accessibility", "ติดตั้งแล้วแชร์หน้าจอ", "ติดตั้งเฉพาะตอนทำรายการก็พอ"],
    why: "แอปปลอม+สิทธิ์พิเศษทำให้ควบคุมเครื่อง/ดูดเงินได้",
    signals: ["ให้ติดตั้งแอปนอกสโตร์", "ขอสิทธิ์พิเศษ", "อ้างแก้ปัญหาด่วน"],
  },
  {
    stem: "ข้อความว่า ‘มีคนพยายามเข้า Facebook’ ให้กรอกรหัส 2FA ในลิงก์ คุณควรทำอะไร?",
    correct: "เข้าแอป Facebook เองแล้วตรวจ Security/Logout sessions",
    wrong: ["กรอกรหัส 2FA ในลิงก์", "ส่งรหัส 2FA ให้ผู้ส่ง", "เปลี่ยนรูปโปรไฟล์แล้วจะปลอดภัย"],
    why: "2FA code ห้ามกรอกในเว็บที่ไม่แน่ใจ",
    signals: ["ขอรหัส 2FA", "ลิงก์ยืนยัน", "อ้างล็อกอินผิดปกติ"],
  },
];

function buildOut(entry: (typeof BANK)[number]): QuizOut {
  const labels = ["A", "B", "C", "D"] as const;

  // ✅ สุ่มตำแหน่ง correct ทุกครั้ง (แก้ปัญหาถูกข้อ 1 ตลอดแบบเด็ดขาด)
  const pool = shuffle([
    { text: entry.correct, isCorrect: true, explanation: "แนวทางนี้ปลอดภัยและลดความเสี่ยงการถูกหลอก" },
    { text: entry.wrong[0], isCorrect: false, explanation: "เสี่ยง/ไม่ใช่วิธีตรวจสอบที่ถูกต้อง" },
    { text: entry.wrong[1], isCorrect: false, explanation: "เสี่ยง/อาจถูกขโมยข้อมูลหรือเงิน" },
    { text: entry.wrong[2], isCorrect: false, explanation: "เสี่ยง/ถูกหลอกให้ทำตามได้ง่าย" },
  ]);

  const options = pool.map((o, idx) => ({
    label: labels[idx],
    text: o.text,
    isCorrect: o.isCorrect,
    explanation: o.explanation,
  }));

  const hash = hashQuiz(entry.stem, options.map((o) => o.text));

  return {
    kind: "quiz",
    stem: entry.stem,
    options,
    whyCorrect: entry.why,
    signals: entry.signals,
    hash,
    source: "fixed20",
  };
}

export async function POST(req: NextRequest) {
  const body = await req.json().catch(() => null);
  const answered = Number(body?.answered ?? 0);

  const idx = Number.isFinite(answered) ? Math.abs(answered) % BANK.length : 0;
  const quiz = buildOut(BANK[idx]);

  return NextResponse.json({ quiz });
}
